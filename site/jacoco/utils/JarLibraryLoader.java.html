<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JarLibraryLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jmeos</a> &gt; <a href="index.source.html" class="el_package">utils</a> &gt; <span class="el_source">JarLibraryLoader.java</span></div><h1>JarLibraryLoader.java</h1><pre class="source lang-java linenums">package utils;

import jnr.ffi.LibraryLoader;

import java.io.*;
import java.net.URL;

/**
 * Utility library to permit the loading of a library in a JAR.
 * &lt;a href=&quot;https://github.com/jnr/jnr-ffi/issues/93#issuecomment-717760847&quot;&gt;...&lt;/a&gt;
 *
 * @param &lt;T&gt; Library defined interface
 * @author Killian Monier and Nidhal Mareghni
 * @since 13/08/2023
 */
public class JarLibraryLoader&lt;T&gt; {

	private final Class&lt;T&gt; libraryClass;
	private final String libraryName;
<span class="fc" id="L20">	private final String projectPath = System.getProperty(&quot;user.dir&quot;);</span>

	/**
	 * Constructor of this class.
	 *
	 * @param libraryClass Class of the library defined interface
	 * @param libraryName  Name of the library
	 */
<span class="fc" id="L28">	public JarLibraryLoader(Class&lt;T&gt; libraryClass, String libraryName) {</span>
<span class="fc" id="L29">		this.libraryClass = libraryClass;</span>
<span class="fc" id="L30">		this.libraryName = libraryName;</span>
<span class="fc" id="L31">	}</span>

	/**
	 * Create a new instance of {@link JarLibraryLoader}
	 *
	 * @param libraryClass Class of the library defined interface
	 * @param libraryName  Name of the library
	 * @param &lt;T&gt;          Library defined interface
	 * @return New instance of JarLibraryLoader
	 */
	public static &lt;T&gt; JarLibraryLoader&lt;T&gt; create(Class&lt;T&gt; libraryClass, String libraryName) {
<span class="fc" id="L42">		return new JarLibraryLoader&lt;&gt;(libraryClass, libraryName);</span>
	}

	public void print_parent_dir() {
<span class="nc" id="L46">		System.out.println(projectPath);</span>
<span class="nc" id="L47">	}</span>

	/**
	 * Copies a file from the JAR resources to a specified destination on the local file system.
	 *
	 * @param resourcePath    The path of the file within the JAR resources to copy.
	 * @param destinationPath The path of the destination where the file will be copied to.
	 * @throws IOException           If an I/O error occurs during the copying process.
	 * @throws FileNotFoundException If the specified resource path cannot be found in the JAR resources.
	 */
	public static void copyFileFromJar(String resourcePath, String destinationPath) throws IOException {
<span class="nc" id="L58">		File destinationFile = new File(destinationPath);</span>
<span class="nc" id="L59">		File parentDirectory = destinationFile.getParentFile();</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">		if (!parentDirectory.exists()) {</span>
<span class="nc" id="L61">			parentDirectory.mkdirs();</span>
		}

<span class="nc" id="L64">		URL resourceUrl = JarLibraryLoader.class.getResource(resourcePath);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">		if (resourceUrl == null) {</span>
<span class="nc" id="L66">			throw new FileNotFoundException(&quot;Resource not found: &quot; + resourcePath);</span>
		}

<span class="nc" id="L69">		try (InputStream inputStream = resourceUrl.openStream();</span>
<span class="nc" id="L70">			 OutputStream outputStream = new FileOutputStream(destinationPath)) {</span>

<span class="nc" id="L72">			byte[] buffer = new byte[1024];</span>
			int length;
<span class="nc bnc" id="L74" title="All 2 branches missed.">			while ((length = inputStream.read(buffer)) &gt; 0) {</span>
<span class="nc" id="L75">				outputStream.write(buffer, 0, length);</span>
			}
		}
<span class="nc" id="L78">	}</span>

	/**
	 * Retrieves the name of the operating system on which the Java program is running.
	 *
	 * @return The name of the operating system (e.g., &quot;Windows&quot;, &quot;Linux&quot;, &quot;macOS&quot;).
	 */
	public static String getOSName() {
<span class="fc" id="L86">		String osName = System.getProperty(&quot;os.name&quot;).toLowerCase();</span>

<span class="pc bpc" id="L88" title="1 of 2 branches missed.">		if (osName.contains(&quot;win&quot;)) {</span>
<span class="nc" id="L89">			return &quot;Windows&quot;;</span>
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">		} else if (osName.contains(&quot;mac&quot;)) {</span>
<span class="nc" id="L91">			return &quot;macOS&quot;;</span>
<span class="pc bpc" id="L92" title="4 of 6 branches missed.">		} else if (osName.contains(&quot;nix&quot;) || osName.contains(&quot;nux&quot;) || osName.contains(&quot;aix&quot;)) {</span>
<span class="fc" id="L93">			return &quot;Linux&quot;;</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">		} else if (osName.contains(&quot;sunos&quot;)) {</span>
<span class="nc" id="L95">			return &quot;Solaris&quot;;</span>
		} else {
<span class="nc" id="L97">			return &quot;Unknown&quot;;</span>
		}
	}

	/**
	 * Provide the library instance.
	 *
	 * @return The library instance
	 */
	public T getLibraryInstance(){
		String libraryPath;
		String libName;
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">		if (System.getenv(&quot;GITHUB_WORKFLOW&quot;) != null) {</span>
<span class="nc" id="L110">			System.out.println(&quot;Running on GitHub Workflow&quot;);</span>
			// Use the LD_LIBRARY_PATH to locate the library
<span class="nc" id="L112">			String ldLibraryPath = System.getenv(&quot;LD_LIBRARY_PATH&quot;);</span>
<span class="nc bnc" id="L113" title="All 4 branches missed.">			if (ldLibraryPath != null &amp;&amp; !ldLibraryPath.isEmpty()) {</span>
<span class="nc" id="L114">				libraryPath = ldLibraryPath;</span>
<span class="nc" id="L115">				System.out.println(&quot;GitHub workflow remote environment path: &quot; + libraryPath);</span>
			} else {
<span class="nc" id="L117">				throw new RuntimeException(&quot;LD_LIBRARY_PATH is not set in GitHub Actions environment&quot;);</span>
			}
<span class="nc" id="L119">			libName= &quot;meos&quot;;</span>
<span class="nc" id="L120">		}</span>
		else {
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">		if (getOSName().equals(&quot;Linux&quot;)) {</span>
<span class="fc" id="L123">			System.out.println(&quot;Running on Linux&quot;);</span>
<span class="fc" id="L124">			libraryPath = projectPath + &quot;/src&quot;;</span>
<span class="fc" id="L125">			System.out.println(&quot;Linux library path: &quot; + libraryPath);</span>
//			copyFileFromJar(&quot;/jmeos/lib&quot;, projectPath + &quot;/src/lib&quot;);
//          System.out.println(&quot;File copied successfully to: &quot; + projectPath + &quot;/src/lib&quot;);
//          return LibraryLoader.create(libraryClass).search(projectPath + &quot;/src/lib&quot;).load(libraryName);
<span class="fc" id="L129">			libName= &quot;libmeos.so&quot;;</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        } else if (getOSName().equals(&quot;Running on Windows&quot;)) {</span>
<span class="nc" id="L131">			System.out.println(&quot;In Windows&quot;);</span>
<span class="nc" id="L132">			libraryPath = projectPath + &quot;\\src\\lib&quot;;</span>
<span class="nc" id="L133">			System.out.println(&quot;Looking for library at: &quot; + projectPath + libraryPath);</span>
//			return LibraryLoader.create(libraryClass).search(projectPath + &quot;\\src\\lib&quot;).load(libraryName);
<span class="nc" id="L135">			libName= &quot;libmeos.so&quot;;</span>
		} else {
<span class="nc" id="L137">			throw new UnsupportedOperationException(&quot;JMEOS is only supported on Linux and Windows OS&quot;);</span>
		}
		}

		try {
<span class="fc" id="L142">			System.out.println(&quot;Loading library from: &quot; + libraryPath);</span>
<span class="fc" id="L143">			return LibraryLoader.create(libraryClass).search(libraryPath).load(libName);</span>
		}
<span class="nc" id="L145">		catch (Exception e) {</span>
<span class="nc" id="L146">			System.err.println(&quot;Unexpected error: &quot; + e.getMessage());</span>
<span class="nc" id="L147">			throw new RuntimeException(e);</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>